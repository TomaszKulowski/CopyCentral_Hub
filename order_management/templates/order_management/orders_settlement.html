{% extends "order_management/base_order_management.html" %}
{% load static %}

{% block content %}
  <script type="text/javascript" src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="{% static 'order_management/scripts/orders_settle_scripts.js' %}"></script>
  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h2>Orders Settlement</h2>
  </div>
  <div class="table-responsive small">
    <table class="table table-striped table-sm">
      <thead class="table-dark">
        <tr>
          <th scope="col" width=5%>#ID</th>
          <th scope="col" width=20%>Customer</th>
          <th scope="col" width=20%>Payer</th>
          <th scope="col" width=10%>Additional Info</th>
          <th scope="col" width=15%>Device</th>
          <th scope="col" width=7%>Status</th>
          <th scope="col" width=10%>Invoice Number</th>
          <th scope="col" width=4%></th>
          <th scope="col" width=4%></th>
        </tr>
      </thead>
      <tbody id="order-table">
        {% for order in page_obj %}
          <tr data-target="#row{{ order.id }}">
            <td><a onclick="handleDropdownClick(event)" class="text-decoration-none link-dark" href="{% url 'orders:order_details' order.id %}"><b>#{{ order.id }}</b></a></td>
            <td><a onclick="handleDropdownClick(event)" class="text-decoration-none link-dark" href="{% url 'customers:customer_details' order.customer.id %}">
              <b>Name:</b> {{ order.customer.name }}<br>
              <b>Address:</b> {{ order.customer.get_address }}
            </a></td>
            {% if not order.payer.id == order.customer.id %}
              <td><a onclick="handleDropdownClick(event)" class="text-decoration-none link-dark" href="{% url 'customers:customer_details' order.payer.id %}">
              <b>Name:</b> {{ order.customer.name }}<br>
              <b>Address:</b> {{ order.customer.get_address }}
              </a></td>
            {% else %}
              <td>The Same Data as Customer</td>
            {% endif %}
            {% if order.additional_info %}
              <td>{{ order.additional_info }}</td>
            {% else %}
              <td>---</td>
            {% endif %}
            {% if order.device %}
              <td>
                <b>Name: </b>{{ order.device.brand }} {{ order.device.model }}<br>
                <b>S/N: </b>{{ order.device.serial_number }}
                {% if order.device.total_counter %}
                  <br><b>Total Counter: </b>{{ order.device.total_counter }}
                {% endif %}
                {% if order.device.mono_counter %}
                  <br><b>Mono Counter: </b>{{ order.device.mono_counter }}
                {% endif %}
                {% if order.device.color_counter %}
                  <br><b>Color Counter: </b>{{ order.device.color_counter }}
                {% endif %}
              </td>
            {% elif order.device_name %}
              <td><b>Name: </b>{{ order.device_name }}</td>
            {% else %}
              <td>---</td>
            {% endif %}
            <td>{{ order.get_status_display }}</td>
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="order_id" value="{{ order.id }}"/>
              <td class="form-class">{{ order_form.invoice_number }}</td>
              <td><button class="btn btn-sm btn-outline-secondary" onclick="toggleDetails({{ order.id }})">Settle</button></td>
            </form>
            <td><button class="btn btn-sm btn-outline-secondary" onclick="toggleDetails({{ order.id }})">Details</button></td>
          </tr>
          <tr></tr>
          <tr id="row{{ order.id }}" class="collapse">
            <td colspan="2">
              <b>Order Details:</b>
              <ul>
                <li><b>Order Intake:</b> {{ order.user_intake }}</li>
                <li><b>Order Type:</b> {{ order.get_order_type_display }}</li>
                <li><b>Payment Method:</b> {{ order.get_payment_method_display }}</li>
              </ul><br>
              <b>Customer Details:</b>
              <ul>
                {% if order.customer.tax %}
                  <li><b>Tax:</b> {{ order.customer.tax }}</li>
                {% endif %}
                {% if order.customer.telephone %}
                  <li><b>Telephone:</b> {{ order.customer.telephone }}</li>
                {% endif %}
                {% if order.customer.email %}
                  <li><b>Email:</b> {{ order.customer.email }}</li>
                {% endif %}
                {% if order.customer.description %}
                  <li><b>Customer Info:</b> {{ order.customer.description }}</li>
                {% endif %}
              </ul>
              {% if not order.payer.id == order.customer.id %}
                <br>
                <b>Payer Details:</b>
                <ul>
                  {% if order.payer.tax %}
                    <li><b>Tax:</b> {{ order.payer.tax }}</li>
                  {% endif %}
                  {% if order.payer.telephone %}
                    <li><b>Telephone:</b> {{ order.payer.telephone }}</li>
                  {% endif %}
                  {% if order.payer.email %}
                    <li><b>Email:</b> {{ order.payer.email }}</li>
                  {% endif %}
                  {% if order.payer.description %}
                    <li><b>Payer Info:</b> {{ order.payer.description }}</li>
                  {% endif %}
                </ul>
              {% endif %}
            </td>
            <td colspan="7">
              <table class="table table-striped table-sm">
                <thead class="table-dark">
                  <tr>
                    <th scope="col" width=5%>#</th>
                    <th scope="col" width=20%>Service</th>
                    <th scope="col" width=10%>Quantity</th>
                    <th scope="col" width=10%>Net Price</th>
                  </tr>
                </thead>
                <tbody>
                  {% for service in order.services.all %}
                    <tr>
                      <td>{{ forloop.counter }}</td>
                      <td>{{ service.name }}</td>
                      <td>{{ service.quantity }}</td>
                      <td>{{ service.price_net }}</td>
                    </tr>
                  {% endfor %}
                    <tr>
                      <td></td>
                      <td></td>
                      <td><b>Total:</b></td>
                      <td>{{ order.total_price }} NET PLN</td>
                    </tr>
                </tbody>
              </table>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}

{% block additional_scripts %}
{% endblock %}
