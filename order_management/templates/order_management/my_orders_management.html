{% extends "base.html" %}
{% load static %}

{% block content %}
  <script type="text/javascript" src="{% static 'admin/js/vendor/jquery/jquery.js' %}"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="{% static 'order_management/scripts/base_scripts.js' %}"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">My Orders</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
      <div class="btn-group me-2">
        <a href="{% url 'orders:order_create' %}" class="btn btn-sm btn-outline-secondary">Add New Order</a>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-12 col-md-4">
      <div class="d-flex flex-wrap flex-md-nowrap">
        <div class="d-flex align-items-center border border-1 p-2 form-control w-100">
          <span class="d-inline me-2">Filter By Region:</span>
          <select id="filterByRegion" class="form-select d-inline">
            {% if selected_region == 'None' %}
              <option hidden="hidden" value="None">No Region Assigned</option>
            {% else %}
              <option hidden="hidden" value="{{ selected_region }}">{{ selected_region }}</option>
            {% endif %}
            <option value="Display All">Display All</option>
            {% for order in orders %}
              {% if order.region == 'None' %}
                <option value="None">No Region Assigned</option>
              {% else %}
                <option value="{{ order.region }}">{{ order.region }}</option>
              {% endif %}
            {% endfor %}
          </select>
        </div>
      </div>
    </div>
  </div>
  {% for order in orders %}
    {% if order.region == 'None' %}
      <div class="region-table None">
        <h2>No Region Assigned</h2>
    {% else %}
      <div class="region-table {{ order.region }}">
        <h2>{{ order.region }}</h2>
    {% endif %}
    <div class="table-responsive small">
      <table class="table table-striped table-sm">
        <thead class="table-dark">
          <tr>
            <th scope="col" width=5%>#ID</th>
            <th scope="col" width=20%>Customer</th>
            <th scope="col" width=10%>Address</th>
            <th scope="col" width=10%>Short Description</th>
            <th scope="col" width=10%>Device</th>
            <th scope="col" width=8%>Status</th>
            <th scope="col" width=8%>Priority</th>
            <th scope="col" width=8%></th>
          </tr>
        </thead>
        <tbody>
          {% for order_details in order.orders_list %}
            <tr class="clickable" data-toggle="collapse" data-executor_id="{{ order.executor_id }}" data-order_id="{{ order_details.order__id }}" data-target="#row{{ order_details.order__id }}">
            <td><a onclick="handleDropdownClick(event)" class="text-decoration-none link-dark" href="{% url 'orders:order_details' order_details.order__id %}"><b>#{{ order_details.order__id }}</b></a></td>
            {% if order_details.customer__id %}
              <td><a onclick="handleDropdownClick(event)" class="text-decoration-none link-dark" href="{% url 'customers:customer_details' order_details.customer__id %}">{{ order_details.customer_name }}</a></td>
            {% else %}
              <td>{{ order_details.customer_name }}</td>
            {% endif %}
            <td>{{ order_details.address_name }}</td>
            <td>{{ order_details.short_description_name }}</td>
            <td>{{ order_details.device_full_name }}</td>
            <td>{{ order_details.status }}</td>
            <td>{{ order_details.priority }}</td>
            <td>
              <div class="btn-group me-2">
                <a onclick="handleDropdownClick(event)" href="{% url 'orders:order_details' order_details.order__id %}" class="btn btn-sm btn-outline-secondary">Details</a>
                <a onclick="handleDropdownClick(event)" href="{% url 'orders:order_update' order_details.order__id %}" class="btn btn-sm btn-outline-secondary">Update</a>
              </div>
            </td>
            </tr>
            <tr></tr>
            <tr id="row{{ order_details.order__id }}" class="collapse">
              <td colspan="3">
                <ul>
                <li><b>Created At:</b> {{ order_details.order__created_at }}</li>
                <li><b>Updated At:</b> {{ order_details.order__updated_at }}</li>
                  <li><b>Order Intake:</b> {{ order_details.order_intake_name }}</li>
                  <li><b>Order Type:</b> {{ order_details.order_type }}</li>
                  <li><b>Payment Method:</b> {{ order_details.payment_method }}</li>
                </ul>
              </td>
              <td colspan="3"><strong>Additional Information:</strong><br>{{ order_details.additional_info_name }}</td>
              <td colspan="3"><strong>Order Description:</strong><br>{{ order_details.description_name }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    </div>
  {% endfor %}
{% endblock %}

{% block additional_scripts %}
  <script type="text/javascript" src="{% static 'order_management/scripts/my_orders_scripts.js' %}"></script>
{% endblock %}
